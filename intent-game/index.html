<!DOCTYPE html>
<html lang="en" data-theme="anoma-redblack">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>AnomaPay Checkout Simulator Game</title>
  <link rel="icon" href="img/logoguild.png" type="image/png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Asimovian:wght@400;700&display=swap" rel="stylesheet">
<style>
/* =============================== THEME: RED–BLACK =============================== */
:root{
  /* palette */
  --bg:#090507;--panel:#14090f;--panel2:#12070c;--text:#f8e9ee;--muted:#e2b9c3;
  --brand:#ff2f55;--brand2:#8b0f25;--line:#2a121a;--outline:rgba(255,80,120,.18);--stripe:#1a0d12;
  --ok:#35d07f;--warn:#ffb84d;--bad:#ff5a60;--gold:#ffd166;--gold2:#ffb84d;--red:#ff2f55;
}
/* reset + base */
*{box-sizing:border-box}
html,body{margin:0;height:100%;overflow:hidden;background:var(--bg);color:var(--text);
  font-family:"Asimovian",system-ui,Segoe UI,Roboto,Helvetica,Arial;}
a{color:inherit;text-decoration:none}

/* backdrop and watermark */
.bgfx{position:fixed;inset:0;z-index:-2;pointer-events:none;background:
  radial-gradient(70vw 70vh at 15% -20%, rgba(255,47,85,.20), transparent 60%),
  radial-gradient(70vw 70vh at 120% 120%, rgba(139,15,37,.18), transparent 60%),
  linear-gradient(180deg,#070407,#0c070b 45%,#070407)}
.fxStars{position:fixed;inset:0;z-index:-1;pointer-events:none}
body:after{
  content:"ANOMAPAY"; position:fixed; inset:auto -10vw 8vh auto; z-index:-1; pointer-events:none;
  font-weight:900; font-size:16vw; letter-spacing:.02em; color:#ff2f5513; transform:rotate(-16deg);
}

/* container => full viewport */
.wrap{display:grid;place-items:stretch;min-height:100svh}
.game{display:grid;grid-template-rows:auto auto 1fr;
  width:100vw;width:100dvw;height:100vh;height:100svh;height:100dvh;border:0;border-radius:0;overflow:hidden;
  background:rgba(20,9,15,.62);backdrop-filter:blur(14px) saturate(120%);-webkit-backdrop-filter:blur(14px) saturate(120%);
  box-shadow:0 16px 48px rgba(0,0,0,.35)
}

/* =============================== APP BAR =============================== */
.appbar{display:grid;grid-template-columns:auto 1fr;gap:12px;align-items:center;
  padding:8px 10px;border-bottom:1px solid var(--stripe);background:linear-gradient(180deg,rgba(20,9,15,.92),rgba(20,9,15,.72))}
.brand{display:flex;gap:10px;align-items:center;min-width:0}
.logo{width:30px;height:30px;border-radius:8px;display:grid;place-items:center;flex:0 0 auto}
.logo svg{display:block}
.head .title{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:15.5px}
.head .subtitle{font-size:11px;color:#e7cbd3}

/* HUD row — compact & wrapped */
.hudRow{display:grid;gap:8px;grid-template-columns:repeat(6,minmax(140px,1fr));align-items:center}
@media (max-width:1400px){.hudRow{grid-template-columns:repeat(4,minmax(160px,1fr))}}
@media (max-width:900px){.hudRow{grid-template-columns:repeat(2,minmax(160px,1fr))}}
.chip,.btn.hud{
  display:inline-flex;justify-content:center;align-items:center;gap:8px;padding:9px 10px;border-radius:12px;
  background:rgba(22,8,12,.6);border:1px solid var(--outline);color:#fff;white-space:nowrap;font-weight:800
}
.chip strong{margin-left:6px}
.btn.hud{cursor:pointer}
.btn.hud.primary{background:linear-gradient(135deg,var(--brand),var(--brand2));box-shadow:0 6px 18px rgba(255,47,85,.18) inset}
.hudRow .rightRail{grid-column:1/-1;display:grid;grid-template-columns:repeat(5,minmax(140px,1fr));gap:8px}
@media (max-width:900px){.hudRow .rightRail{grid-template-columns:repeat(2,minmax(160px,1fr))}}

/* =============================== JUMP BAR =============================== */
.jumpbar{display:grid;gap:8px;padding:6px 10px;border-bottom:1px solid var(--stripe);
  grid-template-columns:repeat(6,1fr)}
@media (max-width:1200px){.jumpbar{grid-template-columns:repeat(3,1fr)}}
@media (max-width:720px){.jumpbar{grid-template-columns:repeat(2,1fr)}}
.jump{display:flex;gap:10px;align-items:center;justify-content:center;padding:10px 12px;border:1px solid var(--outline);
  border-radius:999px;background:#12070c;cursor:pointer;color:#fff;text-shadow:0 1px 0 rgba(0,0,0,.35)}
.jump.active{outline:2px solid rgba(255,47,85,.35)}
.meters{grid-column:1/-1;display:grid;grid-template-columns:repeat(3,1fr);gap:10px;align-items:center}
.meter{display:grid;gap:4px}
.meter label{font-size:12px;color:#e7cbd3}
.track{height:10px;border-radius:999px;border:1px solid var(--line);background:#16090f;overflow:hidden}
.fill{height:100%;width:0%;background:linear-gradient(90deg,#ff6a8a,#b1142e)}
.fill.alt{background:linear-gradient(90deg,#ff9aa9,#ff2f55)}
#soundToggle{justify-self:end}

/* =============================== BOARD LAYOUT (areas) =============================== */
.board{display:grid;gap:12px;padding:12px;min-height:0;
  grid-template-columns:1.2fr 1.2fr 1fr;
  grid-template-areas:
    "scene scene checkout"
    "menu  menu  checkout"
    "log   log   checkout";}
@media (max-width:1280px){
  .board{grid-template-columns:1fr;grid-template-areas:"scene" "menu" "checkout" "log";}
}
.panel{background:rgba(20,9,15,.62);border:1px solid var(--outline);border-radius:14px;padding:12px;display:grid;grid-template-rows:auto 1fr;gap:10px;min-height:0}
.panel-h{display:flex;align-items:center;justify-content:space-between}
.panel-b{overflow:auto;min-height:0}
#panelScene{grid-area:scene}#panelMenu{grid-area:menu}#panelCheckout{grid-area:checkout}#panelLog{grid-area:log}

/* =============================== SCENE =============================== */
.sceneWrap{position:relative;height:300px;border:1px solid var(--line);border-radius:12px;background:linear-gradient(#120812,#0e060c)}
.counter{position:absolute;left:50%;bottom:28px;transform:translateX(-50%);width:84%;height:52px;border-radius:10px;background:linear-gradient(180deg,#2b0f19,#18070e);border:1px solid var(--outline);box-shadow:0 10px 28px rgba(0,0,0,.35) inset}
/* pixel wall menu (30% smaller than original) */
.wallMenu{position:absolute;left:24px;top:22px;width:182px;height:84px;border:2px solid #3a1620;border-radius:6px;background:#1a0a10;box-shadow:0 4px 0 #0c0508 inset,0 0 0 2px #6e1b2b inset}
.wallMenu canvas{image-rendering:pixelated;width:100%;height:100%}
.machine{position:absolute;right:24px;top:22px;width:180px;height:140px;border:2px solid #3a1620;border-radius:8px;background:linear-gradient(#1a0c12,#0f070b);box-shadow:0 4px 0 #060307 inset}
.machine .light{position:absolute;width:10px;height:10px;border-radius:2px;background:#2a2;box-shadow:0 0 8px #2a2;top:10px;left:10px;animation:blink 1.4s infinite}
.machine .light.red{left:auto;right:10px;background:#f44;box-shadow:0 0 8px #f44;animation:blink 1s infinite}
.machine .spout{position:absolute;bottom:26px;left:24px;width:36px;height:10px;background:#252b42;border:2px solid #3a4263;border-radius:3px}
.machine .cup{position:absolute;bottom:10px;left:24px;width:18px;height:14px;border:2px solid #735139;background:#2a1f14;border-radius:2px}
.machine .steam:before,.machine .steam:after{content:"";position:absolute;left:62px;bottom:48px;width:2px;height:16px;background:linear-gradient(#fff,transparent);filter:blur(.4px);animation:steam 1.2s infinite}
.machine .steam:after{left:68px;animation-delay:.4s}
@keyframes blink{50%{filter:brightness(1.4)}}@keyframes steam{0%{opacity:.4;transform:translateY(0)}100%{opacity:0;transform:translateY(-14px)}}
/* avatars */
.avatar{position:absolute;bottom:52px;width:86px;height:122px;border-radius:10px;background:radial-gradient(90px 140px at 50% 60%,#101828,#070a12);border:1px solid var(--outline);display:grid;place-items:center;animation:idle 2.2s ease-in-out infinite}
.avatar:before{content:"";position:absolute;inset:0;border-radius:10px;background:radial-gradient(120px 80px at 50% 10%,#ff6a8a22,transparent)}
@keyframes idle{50%{transform:translateY(-3px)}}
.avFace{font-size:42px;filter:drop-shadow(0 2px 6px rgba(0,0,0,.5))}
.avLeft{left:18%}.avRight{right:18%}
.nameTag{position:absolute;bottom:120px;left:50%;transform:translateX(-50%);padding:4px 10px;border-radius:999px;background:#0f1424;border:1px solid var(--outline);font-size:12px}
.bubble{position:absolute;bottom:164px;left:50%;transform:translateX(-50%);max-width:78%;background:#150810;border:1px solid var(--outline);border-radius:12px;padding:10px 12px;font-size:14px;box-shadow:0 10px 24px rgba(0,0,0,.35)}
.bubble:after{content:"";position:absolute;left:50%;bottom:-8px;transform:translateX(-50%) rotate(45deg);width:14px;height:14px;background:#150810;border-left:1px solid var(--outline);border-bottom:1px solid var(--outline)}
.emote{position:absolute;top:-10px;right:-10px;width:26px;height:26px;border-radius:999px;border:1px solid var(--outline);display:grid;place-items:center;background:#1a2136;font-size:14px;opacity:0;transform:translateY(-6px);transition:.18s}
.emote.show{opacity:1;transform:none}
/* Talk FAB inside scene */
.talkFab{position:absolute;left:50%;bottom:16px;transform:translateX(-50%);border-radius:999px;padding:12px 18px;font-size:14px;z-index:2}

/* =============================== MENU LIST =============================== */
.search{background:#13070d;border:1px solid var(--line);border-radius:10px;color:#fff;padding:10px;min-width:200px;width:420px;max-width:100%}
.menuTabs{display:flex;flex-wrap:wrap;gap:6px}
.tabBtn{padding:8px 12px;border-radius:999px;border:1px solid var(--outline);background:#12070c;cursor:pointer}
.tabBtn.active{outline:2px solid rgba(255,47,85,.35)}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;min-height:0}
@media(max-width:1200px){.grid{grid-template-columns:1fr}}
.card{display:grid;grid-template-columns:56px 1fr auto;gap:12px;align-items:center;padding:12px;border:1px solid var(--line);border-radius:12px;background:#13070d;position:relative;overflow:hidden}
.card:before{content:"";position:absolute;inset:-40% 50% auto -40%;height:160px;background:radial-gradient(240px 80px at 0 0,rgba(255,47,85,.18),transparent);transform:rotate(14deg)}
.thumb{width:56px;height:56px;border-radius:8px;display:grid;place-items:center;background:linear-gradient(135deg,#1a0b11,#0e060a);font-size:22px}
@media(max-width:520px){.thumb{width:48px;height:48px;font-size:20px} .card{grid-template-columns:48px 1fr auto}}
.card .title{font-weight:800;color:#fff}
.card .desc{font-size:12px;color:#e7cbd3}
.card .tags{display:flex;gap:6px;margin-top:6px}
.badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--outline);background:#12070c}
.card .actions{display:grid;gap:8px;justify-items:end;min-width:132px}
.price{font-weight:900;font-family:ui-monospace,Consolas,Menlo,monospace;color:#ffe6ec}
.btn{cursor:pointer;border:none;border-radius:12px;padding:10px 12px;font-weight:800;color:#fff;background:#12090f;border:1px solid var(--line);transition:transform .06s,filter .18s,opacity .18s}
.btn:active{transform:translateY(1px)}.btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff}
.btn.ghost{background:transparent;color:#fff}.btn.pill{border-radius:999px}
.btn.add{padding:12px 16px;font-size:14px;border-radius:14px;min-width:120px;line-height:1}
.btn.add.ghost{border-color:#ffffff33;background:rgba(255,255,255,.06)}
.btn:focus-visible{outline:2px dashed var(--gold);outline-offset:2px}
.btn[disabled]{opacity:.5;cursor:not-allowed}

/* =============================== CHECKOUT =============================== */
.cart{display:grid;gap:8px}
.cartRow{display:grid;grid-template-columns:1fr minmax(70px,90px) minmax(116px,140px) minmax(90px,120px);gap:10px;align-items:center;padding:10px;border:1px dashed var(--line);border-radius:10px;background:#13070d}
.cartRow .name{font-weight:800}
.qtyCtl{display:flex;gap:6px;align-items:center}
.sum{margin-top:8px;border-top:1px solid var(--line);padding-top:8px;display:grid;gap:4px}
.sum .row{display:flex;justify-content:space-between;color:#f1d3db}
.sum b{font-family:ui-monospace,Consolas,Menlo,monospace}
.bigpay .btn{width:100%;padding:16px 18px;border-radius:14px;font-size:18px;box-shadow:0 0 0 1px rgba(255,47,85,.15) inset}
.smartBox{margin-top:10px;background:#13070d;border:1px dashed var(--line);border-radius:10px;padding:10px}
.smartBox .title{font-weight:900;margin-bottom:6px}
.hidden{display:none!important}

/* =============================== LOG =============================== */
.loglist{height:100%;overflow:auto;background:#10060c;border:1px solid var(--line);border-radius:10px;padding:10px;font-family:ui-monospace,Consolas,Menlo,monospace;font-size:12.5px}
.logrow{display:grid;grid-template-columns:84px 90px 1fr;gap:8px;padding:6px 0;border-bottom:1px dashed #2a121a}
.logrow:last-child{border-bottom:none}
.logrow .t{color:#d9abbb}.logrow .k.info{color:#5ad1ff}.logrow .k.warn{color:#ffb84d}.logrow .k.good{color:#6dff9a}.logrow .k.bad{color:#ff7b88}
.logCtrl{display:flex;gap:8px;align-items:center}
.logSearch{background:#13070d;border:1px solid var(--line);border-radius:10px;color:#fff;padding:8px 10px;width:260px}
.filterRow{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.filterBtn{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,80,120,.2);background:#12070c;cursor:pointer}
.filterBtn.active{outline:2px solid rgba(255,47,85,.35)}

/* =============================== OVERLAYS / MODALS =============================== */
.overlay{position:fixed;inset:0;display:grid;place-items:center;background:rgba(7,9,14,.72);backdrop-filter:blur(4px);
  opacity:0;pointer-events:none;transition:opacity .18s;z-index:50}
.overlay.show{opacity:1;pointer-events:auto}
.modal{width:min(1100px,92vw);max-height:82vh;overflow:auto;background:rgba(20,9,15,.82);border:1px solid var(--outline);
  border-radius:16px;padding:16px}
.centered{display:grid;place-items:center;text-align:center}
.sparkle{animation:spark 2s ease-in-out infinite}@keyframes spark{50%{text-shadow:0 0 16px #ff6a8a99}}
.welcomeGrid{display:grid;gap:10px}
.tip{font-size:12px;color:#e7cbd3;opacity:.9}

/* =============================== PAY MODAL =============================== */
.paygrid{display:grid;grid-template-columns:1fr 1.1fr;gap:12px}
@media(max-width:920px){.paygrid{grid-template-columns:1fr}}
.qrwrap{display:grid;place-items:center;border:1px dashed var(--line);border-radius:12px;padding:16px;background:#13070d}
#qrCanvas{width:260px;height:260px;border-radius:8px;background:#0c1324;border:1px solid var(--line)}
.intent{display:grid;gap:8px}
.kv{display:flex;justify-content:space-between}
.routeBox{border:1px solid var(--line);border-radius:10px;padding:10px;background:#13070d}
.routeVis{height:96px}
.compare{display:grid;gap:6px;margin-top:6px}
.bar{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center}
.bar .track{height:10px;border:1px solid var(--line);border-radius:999px;background:#16090f;overflow:hidden}
.bar .fill{height:100%;background:linear-gradient(90deg,#ff2f55,#ff6a8a)}

/* timing mini-game (improved) */
.skill{border:1px solid var(--line);border-radius:12px;padding:10px;margin-top:8px;background:#13070d}
.skillHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.band{position:relative;height:18px;border-radius:999px;background:#0e1426;border:1px solid var(--line);overflow:hidden;margin-bottom:8px}
.zone{position:absolute;left:40%;width:20%;top:0;bottom:0;background:linear-gradient(90deg,rgba(46,204,113,.25),rgba(255,255,255,.05))}
.marker{position:absolute;top:0;bottom:0;width:3px;background:#ff9db0;box-shadow:0 0 6px rgba(255,110,150,.9)}
.skillNote{color:#cbd6ea;font-size:12px}
.crit{position:absolute;left:50%;top:-12px;transform:translate(-50%,-50%);font-weight:900;color:#ffef8a;text-shadow:0 2px 12px rgba(255,235,120,.8);opacity:0;transition:opacity .18s,transform .18s}
@keyframes bandshake{0%{transform:translateX(0)}25%{transform:translateX(-3px)}50%{transform:translateX(3px)}75%{transform:translateX(-3px)}100%{transform:translateX(0)}}.shake{animation:bandshake .4s linear}

/* =============================== MISSIONS / BOSS / SKINS / RECEIPT =============================== */
.qgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
@media(max-width:820px){.qgrid{grid-template-columns:1fr}}
.qcard{border:1px solid var(--outline);border-radius:12px;background:#13070d;padding:12px}
.qh{font-weight:900;margin-bottom:6px}
.qitem{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;border:1px dashed var(--line);border-radius:10px;padding:8px;margin:6px 0}
.tag{background:#12070c;border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:12px}
.skinRow{display:flex;gap:10px;flex-wrap:wrap}
.skin{border:1px solid var(--outline);border-radius:10px;padding:8px 10px;background:#13070d;cursor:pointer}
.skin.active{outline:2px solid rgba(255,47,85,.35)}

.rcpCard{width:min(520px,90vw);background:#13070d;border:1px solid var(--line);border-radius:14px;padding:14px;margin:auto}
.rcpTop{display:flex;align-items:center;gap:10px}
.rcpLogo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#3a1722,#0b0709)}
.rcpTbl{width:100%;border-collapse:collapse;margin-top:10px}
.rcpTbl th,.rcpTbl td{border-bottom:1px dashed var(--line);padding:6px 4px;font-size:14px}
.rcpTbl th{color:#cfe2ff;text-align:left}
.rcpTbl td:last-child{text-align:right}
.rcpFoot{display:grid;gap:4px;margin-top:8px}
.rcpBtns{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

/* pixel avatars container for retro skin */
.avatar.pixel{width:96px;height:96px;border-radius:4px;background:#0b0f19;border:1px solid var(--outline);display:grid;place-items:center}
.avatar.pixel canvas{width:88px;height:88px;image-rendering:pixelated;image-rendering:crisp-edges;border-radius:2px}

/* toast */
.toasts{position:fixed;right:14px;bottom:14px;display:grid;gap:8px;z-index:200}
.toast{background:#15090e;border:1px solid var(--outline);padding:10px 12px;border-radius:12px;min-width:220px;box-shadow:0 8px 24px rgba(0,0,0,.3)}
.toast.good{border-color:#2c6}.toast.warn{border-color:#b85}.toast.bad{border-color:#c66}
.toastTitle{font-weight:800;margin-bottom:4px}
</style>
</head>
<body>
<canvas class="fxStars" id="fxStars"></canvas>
<div class="bgfx"></div>
<div class="toasts" id="toasts"></div>

<div class="wrap">
  <div class="game" id="game">
    <!-- =============================== APP BAR =============================== -->
    <header class="appbar">
      <div class="brand">
        <div class="logo" aria-label="AnomaPay logo">
          <!-- on-brand red/orbit logo -->
          <svg width="30" height="30" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <defs>
              <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="#ff2f55"/><stop offset="1" stop-color="#8b0f25"/>
              </linearGradient>
              <radialGradient id="g2" cx="50%" cy="50%" r="50%">
                <stop offset="0" stop-color="#ffb3c1"/><stop offset="1" stop-color="#ff2f55"/>
              </radialGradient>
            </defs>
            <rect x="0" y="0" width="40" height="40" rx="10" fill="url(#g1)"/>
            <circle cx="20" cy="20" r="10" fill="#12070c" opacity=".55"/>
            <circle cx="20" cy="20" r="6" fill="url(#g2)"/>
            <path d="M7 20c12-10 26-10 26 0" fill="none" stroke="#ffd2db" stroke-width="1.5" opacity=".5"/>
          </svg>
        </div>
        <div class="head">
          <div class="title">AnomaPay — Arcade Checkout</div>
          <div class="subtitle">Intents • ZK privacy • best-route routing</div>
        </div>
      </div>

      <!-- HUD CHIPS (compact, responsive) -->
      <div class="hudRow">
        <div class="chip">Items <strong id="hudItems">0</strong></div>
        <div class="chip">Total <strong id="hudTotal">$0.00</strong></div>
        <div class="chip">XP <strong id="hudPts">0</strong></div>
        <div class="chip">Level <strong id="hudLvl">1</strong></div>
        <div class="chip">Streak <strong id="hudStreak">0</strong></div>
        <div class="chip">Timer <strong id="hudTimer">00:00</strong></div>

        <div class="rightRail">
          <button class="btn hud pill" id="btnMissions">Missions</button>
          <button class="btn hud pill" id="btnBoss">Boss</button>
          <button class="btn hud pill" id="btnSkins">Skins</button>
          <button class="btn hud pill" id="btnFull">Fullscreen</button>
          <button class="btn hud pill" id="btnSetup">Settings</button>
        </div>
      </div>
    </header>

    <!-- =============================== JUMP BAR =============================== -->
    <div class="jumpbar">
      <button class="jump active" id="jumpScene">🧩 Scene</button>
      <button class="jump" id="jumpMenu">🍽️ Menu</button>
      <button class="jump" id="jumpCheckout">🧾 Checkout</button>
      <button class="jump" id="jumpLog">🖥️ Activity Log</button>
      <div class="meters">
        <div class="meter"><label>Energy</label><div class="track"><div class="fill" id="energyFill"></div></div></div>
        <div class="meter"><label>Combo</label><div class="track"><div class="fill alt" id="comboFill"></div></div></div>
        <button class="btn pill" id="soundToggle">🔊 Sound</button>
      </div>
    </div>

    <!-- =============================== BOARD =============================== -->
    <main class="board">
      <!-- Scene -->
      <section class="panel" id="panelScene">
        <div class="panel-h">
          <div><strong>Counter Scene</strong> <span style="opacity:.7">— chat with the cashier (E)</span></div>
          <div class="sceneBtns">
            <select class="btn pill" id="roleSel" title="Sprite Style">
              <option value="adventurer">Adventurer (Red–Gold)</option>
              <option value="mage">Mage (Red–Gold)</option>
              <option value="hero" selected>Hero (Red–Gold)</option>
            </select>
            <button class="btn pill" id="btnQuest">📜 Quest</button>
          </div>
        </div>
        <div class="panel-b">
          <div class="sceneWrap" id="scene">
            <div class="wallMenu"><canvas id="menuBoard" width="130" height="65" aria-label="pixel wall menu"></canvas></div>
            <div class="machine">
              <div class="light"></div><div class="light red"></div>
              <div class="spout"></div><div class="cup"></div><div class="steam"></div>
            </div>
            <div class="counter"></div>

            <div class="avatar avLeft" id="cust"><div class="avFace">🧑‍🚀</div><div class="emote" id="custEmote">✨</div></div>
            <div class="avatar avRight" id="cashier"><div class="avFace">🧙‍♂️</div><div class="emote" id="cashEmote">💡</div></div>

            <div class="nameTag" id="nameTag">anoma customer • anomapay cashier</div>
            <div class="bubble" id="bubble">Welcome to ANOMAPAY CAFE! Press <span class="kbd">E</span> or hit <b>Talk</b> below.</div>
            <button class="btn primary talkFab" id="btnTalkScene">💬 Talk</button>
          </div>
        </div>
      </section>

      <!-- Menu -->
      <section class="panel" id="panelMenu">
        <div class="panel-h">
          <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center">
            <strong>Menu</strong>
            <div class="menuTabs" id="menuTabs">
              <button class="tabBtn active" data-cat="all">All</button>
              <button class="tabBtn" data-cat="coffee">Coffee</button>
              <button class="tabBtn" data-cat="bakery">Bakery</button>
              <button class="tabBtn" data-cat="food">Food</button>
              <button class="tabBtn" data-cat="beans">Beans</button>
            </div>
          </div>
          <input id="search" class="search" placeholder="Search items..."/>
        </div>
        <div class="panel-b"><div class="grid" id="grid"></div></div>
      </section>

      <!-- Checkout -->
      <section class="panel" id="panelCheckout">
        <div class="panel-h">
          <div><strong>Cart & Checkout</strong></div>
          <button class="btn ghost" id="btnClear">Clear</button>
        </div>
        <div class="panel-b">
          <div class="cart" id="cart"></div>
          <div id="smartBox" class="smartBox hidden">
            <div class="title">Smart suggestions</div>
            <div id="smartList"></div>
          </div>
          <div class="sum">
            <div class="row"><span>Subtotal</span><b id="subtotal">$0.00</b></div>
            <div class="row"><span>Discounts</span><b id="discount">-$0.00</b></div>
            <div class="row"><span>Sales Tax (7.5%)</span><b id="tax">$0.00</b></div>
            <div class="row"><span>Fees (est.)</span><b id="fees">$0.00</b></div>
            <div class="row"><span><b>Total</b></span><b id="total">$0.00</b></div>
          </div>
          <div class="bigpay"><button class="btn primary" id="btnPay" disabled>◎ Pay with AnomaPay</button></div>
        </div>
      </section>

      <!-- Log -->
      <aside class="panel" id="panelLog">
        <div class="panel-h">
          <div style="display:grid;gap:6px">
            <strong>Activity Log</strong>
            <div class="filterRow">
              <button class="filterBtn active" data-f="all">All</button>
              <button class="filterBtn" data-f="good">Good</button>
              <button class="filterBtn" data-f="warn">Warn</button>
              <button class="filterBtn" data-f="bad">Bad</button>
              <button class="filterBtn" data-f="info">Info</button>
            </div>
          </div>
          <div class="logCtrl">
            <input id="logSearch" class="logSearch" placeholder="Search log..."/>
            <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="autoScroll" checked/> Auto</label>
            <button class="btn ghost" id="btnCopy">Copy</button>
            <button class="btn ghost" id="btnClearLog">Clear</button>
          </div>
        </div>
        <div class="panel-b"><div class="loglist" id="log"></div></div>
      </aside>
    </main>
  </div>
</div>

<!-- =============================== SETTINGS MODAL =============================== -->
<div class="overlay" id="settingsOv">
  <div class="modal">
    <h2>Settings</h2>
    <div class="qgrid">
      <div class="qcard">
        <div class="qh">Appearance</div>
        <div class="qitem"><div>Skin</div>
          <div>
            <select id="skinSel" class="btn pill">
              <option value="pixel-retro">Pixel Retro (Red–Gold)</option>
              <option value="apple-redglass">Apple Red Glass</option>
              <option value="pro-dark">Pro Dark</option>
              <option value="white-air">White Air</option>
            </select>
          </div>
        </div>
        <div class="qitem"><div>Font size</div>
          <div>
            <select id="fsSel" class="btn pill">
              <option value="1">Normal</option>
              <option value="1.05">Large</option>
              <option value="1.12">X-Large</option>
            </select>
          </div>
        </div>
      </div>
      <div class="qcard">
        <div class="qh">Behavior</div>
        <div class="qitem"><div>Sound</div>
          <div><label class="btn pill"><input type="checkbox" id="soundChk" checked/> On</label></div>
        </div>
        <div class="qitem"><div>Currency (display)</div>
          <div>
            <select id="ccySel" class="btn pill">
              <option value="$">$ (USD)</option>
              <option value="฿">฿ (THB)</option>
              <option value="€">€ (EUR)</option>
            </select>
          </div>
        </div>
        <div class="qitem"><div>Timing Tap difficulty</div>
          <div>
            <select id="diffSel" class="btn pill">
              <option value="1">Normal</option>
              <option value="1.25">Hard</option>
              <option value="1.5">Insane</option>
            </select>
          </div>
        </div>
      </div>
    </div>
    <div class="rowbtns" style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn" id="btnCloseSettings">Close</button>
      <button class="btn primary" id="btnSaveSettings">Save</button>
    </div>
  </div>
</div>

<!-- =============================== WELCOME (fun) =============================== -->
<div class="overlay" id="welcomeOv">
  <div class="modal centered">
    <div class="welcomeGrid">
      <h2 class="sparkle">Insert Coin to <span style="color:#ff6a8a">AnomaPay Arcade</span> ✨</h2>
      <p style="margin:0">Scan • Route • ZK — earn XP, crush quests, and beat the Boss.</p>
      <div class="tip" id="rotTip">Tip: Hit a <b>CRITICAL</b> in Timing Tap to halve fees!</div>
      <div style="display:flex;gap:8px;justify-content:center;align-items:center;margin-top:6px;flex-wrap:wrap">
        <label>Difficulty</label>
        <select id="welcomeDiff" class="btn pill">
          <option value="1">Normal</option>
          <option value="1.25">Hard</option>
          <option value="1.5">Insane</option>
        </select>
        <label style="margin-left:10px"><input type="checkbox" id="skipNext"/> Don’t show again</label>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
        <button class="btn" id="startBtn">Press Start</button>
        <button class="btn primary" id="bonusBtn">🎲 Surprise Me</button>
      </div>
    </div>
  </div>
</div>

<!-- =============================== PAY MODAL =============================== -->
<div class="overlay" id="payOv">
  <div class="modal">
    <h2>Scan to Pay — AnomaPay</h2>
    <div class="paygrid">
      <div class="qrwrap">
        <canvas id="qrCanvas" width="260" height="260" aria-label="checkout QR"></canvas>
        <div id="qrStr" style="font-size:11px;opacity:.7;margin-top:6px;max-width:260px;word-break:break-all">—</div>
      </div>
      <div class="intent">
        <div class="kv"><span>Amount</span><b id="iAmount">$0.00</b></div>
        <div class="kv"><span>Assets</span><b id="iAssets">USDC → USDC</b></div>
        <div class="kv"><span>Privacy</span><b id="iPrivacy">ZK</b></div>
        <div class="kv"><span>Policy</span><b id="iPolicy">max slip 0.5% · avoid —</b></div>
        <div class="kv"><span>ETA</span><b id="iETA">— s</b></div>
        <div class="kv"><span>Fees</span><b id="iFees">$0.00</b></div>
        <div class="kv"><span>Slippage</span><b id="iSlip">0%</b></div>
        <div class="routeBox">
          <div class="kv"><span>Recommended Route</span><b id="iRoute">—</b></div>
          <div class="routeVis" id="routeVis"></div>
          <div id="iHops" style="font-size:12px;color:#cbd6ea;margin-top:6px"></div>
          <div class="compare" id="compare"></div>
        </div>

        <!-- Timing Tap -->
        <div class="skill">
          <div class="skillHead">
            <div>Timing Tap</div>
            <div>
              <span class="badge" id="roundBadge">Round 1/3</span>
              <span class="badge" id="scoreBadge">Score 0</span>
            </div>
          </div>
          <div class="band" id="skillBand">
            <div class="zone" id="skillZone"></div>
            <div class="marker" id="skillMark"></div>
            <div id="crit" class="crit">CRITICAL!</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
            <button class="btn pill" id="skillTap">Tap</button>
            <div class="skillNote" id="skillNote">Aim for the bright zone. Perfect/Great/Good tiers. 3 rounds total.</div>
          </div>
        </div>
      </div>
    </div>
    <div class="rowbtns" style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button class="btn ghost" id="btnClosePay">Close</button>
      <button class="btn" id="btnSimScan">Simulate Scan</button>
      <button class="btn primary" id="btnApprove">Approve & Settle</button>
    </div>
  </div>
</div>

<!-- =============================== MISSIONS / BOSS / SKINS =============================== -->
<div class="overlay" id="missionOv">
  <div class="modal">
    <h2>Daily & Weekly Missions</h2>
    <div class="qgrid">
      <div class="qcard">
        <div class="qh">Daily</div>
        <div id="dailyBox"></div>
      </div>
      <div class="qcard">
        <div class="qh">Weekly</div>
        <div id="weeklyBox"></div>
      </div>
    </div>
    <div class="rowbtns"><button class="btn" id="closeMissions">Close</button></div>
  </div>
</div>

<div class="overlay" id="bossOv">
  <div class="modal">
    <h2>Boss Challenge</h2>
    <p id="bossRule">—</p>
    <div class="meter" style="max-width:420px"><label>Time</label><div class="track"><div class="fill" id="bossFill"></div></div></div>
    <div class="rowbtns"><button class="btn" id="bossClose">Cancel</button><button class="btn primary" id="bossStart">Start</button></div>
  </div>
</div>

<div class="overlay" id="skinOv">
  <div class="modal">
    <h2>Card Skins</h2>
    <div class="skinRow">
      <div class="skin active" data-skin="pixel-retro">Pixel Retro</div>
      <div class="skin" data-skin="apple-redglass">Apple Red Glass</div>
      <div class="skin" data-skin="pro-dark">Pro Dark</div>
      <div class="skin" data-skin="white-air">White Air</div>
    </div>
    <p style="opacity:.8;margin-top:8px">Skins affect card/background accents; core theme remains readable.</p>
    <div class="rowbtns"><button class="btn" id="skinClose">Close</button></div>
  </div>
</div>

<!-- =============================== RECEIPT =============================== -->
<div class="overlay" id="rcpOv">
  <div class="modal">
    <div class="rcpCard" id="rcpCard">
      <div class="rcpTop">
        <div class="rcpLogo"></div>
        <div>
          <div style="font-weight:900">ANOMAPAY CAFE</div>
          <div style="font-size:12px;color:#cbd6ea">Paid with AnomaPay</div>
        </div>
        <div style="margin-left:auto;font-size:12px;color:#cbd6ea" id="rcpTime">—</div>
      </div>
      <table class="rcpTbl" id="rcpTbl">
        <thead><tr><th>Item</th><th>Qty</th><th>Price</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="rcpFoot" id="rcpFoot"></div>
      <div class="rcpBtns">
        <button class="btn ghost" id="rcpClose">Close</button>
        <button class="btn" id="rcpCopy">Share (copy)</button>
      </div>
    </div>
  </div>
</div>

<script>
'use strict';
/* =============================== DATA =============================== */
const TAX=0.075;
const STORE=[
  {id:'p1',name:'Espresso',price:3.50,desc:'Double shot, rich & bold',icon:'☕',cat:'coffee',tags:['hot','classic']},
  {id:'p2',name:'Latte',price:4.75,desc:'Milk smoothness, classic',icon:'☕',cat:'coffee',tags:['milky']},
  {id:'p3',name:'Cappuccino',price:4.50,desc:'Foamy delight',icon:'☕',cat:'coffee',tags:['foam']},
  {id:'p4',name:'Cold Brew',price:5.00,desc:'Slow-steeped, refreshing',icon:'🥤',cat:'coffee',tags:['cold']},
  {id:'p5',name:'Croissant',price:3.25,desc:'Buttery, flaky',icon:'🥐',cat:'bakery',tags:['butter']},
  {id:'p6',name:'Blueberry Muffin',price:3.00,desc:'Sweet & soft',icon:'🧁',cat:'bakery',tags:['sweet']},
  {id:'p7',name:'Turkey Sandwich',price:6.90,desc:'Hearty lunch',icon:'🥪',cat:'food',tags:['protein']},
  {id:'p8',name:'Beans (250g)',price:12.00,desc:'House roast',icon:'🫘',cat:'beans',tags:['home brew']}
];
const CHAINS=['Osmosis','Linea','Polygon','BSC','Noble','Arbitrum','Base','Optimism','Ethereum'];
const BRIDGES=['IBC','Across','LayerZero','CCTP','Wormhole'];

const CART=new Map();
const GAME={xp:0,lvl:1,streak:0,energy:30,combo:0,quest:null};
let tId=null,tStart=null,SOUND=true,SKIN='pixel-retro',CCY='$',FONT_SCALE=1,DIFF=1;

/* =============================== AUDIO / SFX =============================== */
const SFX={
  ctx:null,
  init(){try{this.ctx=new (window.AudioContext||window.webkitAudioContext)()}catch{}},
  tone(f=860,ms=70,g0=0.12){try{if(!SOUND||!this.ctx) return; const t=this.ctx.currentTime;const o=this.ctx.createOscillator(),g=this.ctx.createGain();
    o.type='triangle';o.frequency.setValueAtTime(f,t);g.gain.setValueAtTime(g0,t);g.gain.exponentialRampToValueAtTime(0.00001,t+ms/1000);o.connect(g).connect(this.ctx.destination);o.start(t);o.stop(t+ms/1000)}catch{}},
  coin(){this.tone(1200,90)},click(){this.tone(680,60)},success(){this.tone(1500,140,0.14)},warn(){this.tone(260,90,0.11)},
  perfect(){this.tone(1700,160,0.16)},great(){this.tone(1350,140,0.14)},good(){this.tone(1100,120,0.13)},notice(){this.tone(980,120,0.12)}
};SFX.init();

/* =============================== HELPERS =============================== */
const $=id=>document.getElementById(id);
const money=n=>CCY+(n.toFixed(2));
const nowStr=()=>new Date().toLocaleTimeString([], {hour12:false});
function log(type,msg,kind='info'){
  const row=document.createElement('div');row.className='logrow';
  row.dataset.kind=kind; row.innerHTML=`<div class="t">${nowStr()}</div><div class="k ${kind}">${type}</div><div>${msg}</div>`;
  const list=$('log'); list.appendChild(row);
  // filter
  applyLogFilter();
  if($('autoScroll') && $('autoScroll').checked) list.scrollTop=list.scrollHeight;
}
function pick(a){return a[Math.floor(Math.random()*a.length)]}
function toast(title,msg,kind='good'){
  const box=$('toasts');const t=document.createElement('div');t.className='toast '+kind;
  t.innerHTML=`<div class="toastTitle">${title}</div><div>${msg}</div>`;box.appendChild(t);
  if(kind==='good') SFX.success(); else if(kind==='warn'||kind==='bad') SFX.warn(); else SFX.notice();
  setTimeout(()=>{t.style.opacity='0';t.style.transform='translateY(6px)';setTimeout(()=>t.remove(),260)},2400)
}

/* =============================== BACKGROUND STARS =============================== */
(function stars(){
  const c=$('fxStars'),ctx=c.getContext('2d');let w=0,h=0;const dpr=window.devicePixelRatio||1;
  function resize(){w=innerWidth;h=innerHeight;c.width=w*dpr;c.height=h*dpr;c.style.width=w+'px';c.style.height=h+'px';ctx.setTransform(dpr,0,0,dpr,0,0)}
  resize();addEventListener('resize',resize);
  const pts=Array.from({length:120},()=>({x:Math.random()*w,y:Math.random()*h,a:Math.random()*0.6+0.2,s:Math.random()*0.6+0.2}));
  (function tick(){ctx.clearRect(0,0,w,h);pts.forEach(p=>{p.a+=0.02;p.y+=p.s;if(p.y>h)p.y=0;ctx.globalAlpha=0.3+Math.sin(p.a)*0.25;ctx.fillStyle='#ff6a8a';ctx.fillRect(p.x,p.y,1.2,1.2)});requestAnimationFrame(tick)})();
})();

/* =============================== HUD =============================== */
function startTimer(){ if(tId) return; tStart=Date.now(); tId=setInterval(()=>{const s=Math.floor((Date.now()-tStart)/1000);
  const mm=String(Math.floor(s/60)).padStart(2,'0'), ss=String(s%60).padStart(2,'0'); $('hudTimer').textContent=`${mm}:${ss}`;
  GAME.energy=Math.max(0,GAME.energy-0.1); GAME.combo=Math.max(0,GAME.combo-0.25); updateHUD(); },500)}
function stopTimer(){clearInterval(tId);tId=null;tStart=null}
function updateHUD(){const {total,qty}=totals();$('hudItems').textContent=qty;$('hudTotal').textContent=money(total);
  $('hudPts').textContent=GAME.xp;$('hudLvl').textContent=GAME.lvl;$('hudStreak').textContent=GAME.streak;
  $('energyFill').style.width=Math.min(100,GAME.energy)+'%';$('comboFill').style.width=Math.min(100,GAME.combo)+'%'}
function award(n,why=''){GAME.xp+=n;if(GAME.xp>=100){GAME.xp-=100;GAME.lvl++;log('level','Level up!','good')}updateHUD(); if(why) log('xp','+'+n+' '+why,'good')}
function bump(){GAME.energy=Math.min(100,GAME.energy+7);GAME.combo=Math.min(100,GAME.combo+12);award(2,'action')}

/* =============================== NAV / JUMPS =============================== */
function setJump(sel){['jumpScene','jumpMenu','jumpCheckout','jumpLog'].forEach(id=>$(id).classList.toggle('active',id===sel))}
$('jumpScene').onclick=()=>{$('panelScene').scrollIntoView({behavior:'smooth'});setJump('jumpScene');SFX.click()};
$('jumpMenu').onclick=()=>{$('panelMenu').scrollIntoView({behavior:'smooth'});setJump('jumpMenu');SFX.click()};
$('jumpCheckout').onclick=()=>{$('panelCheckout').scrollIntoView({behavior:'smooth'});setJump('jumpCheckout');SFX.click()};
$('jumpLog').onclick=()=>{$('panelLog').scrollIntoView({behavior:'smooth'});setJump('jumpLog');SFX.click()};
$('soundToggle').onclick=()=>{SOUND=!SOUND;$('soundToggle').textContent=(SOUND?'🔊':'🔇')+' Sound';SFX.click()}

/* =============================== WELCOME =============================== */
(function welcome(){
  const tips=[
    'Tip: Perfect hit gives -40% fees, Great -28%, Good -15%.',
    'Tip: Add 3+ items for a 5% cart discount.',
    'Tip: Complete quests for bonus XP and coupons.',
    'Tip: Boss rules change every run — read carefully!'
  ];
  let idx=0; setInterval(()=>{$('rotTip').textContent=tips[idx=(idx+1)%tips.length]},2200);
  try{const skip = localStorage.getItem('ap_skip_welcome')==='1'; if(!skip){ $('welcomeOv').classList.add('show'); }}catch{}
  const applyDiff=(v)=>{DIFF=parseFloat(v)||1;};
  $('welcomeDiff').onchange=e=>applyDiff(e.target.value);
  $('startBtn').onclick=()=>{ try{ if($('skipNext').checked) localStorage.setItem('ap_skip_welcome','1'); }catch{} $('welcomeOv').classList.remove('show'); SFX.success(); };
  $('bonusBtn').onclick=()=>{ const skins=['pixel-retro','apple-redglass','pro-dark','white-air']; SKIN=pick(skins); applySkin(); award(5,'bonus start'); toast('Surprise!','Random skin equipped +5 XP','good'); $('welcomeOv').classList.remove('show'); };
})();

/* =============================== SCENE / DIALOG =============================== */
const LINES={
  idle:[
    {who:'cashier',text:'Welcome, traveler! Espresso? Latte? Or… a quest?'},
    {who:'cashier',text:'Toggle ZK to keep your route private like a stealth spell.'},
    {who:'customer',text:'What’s the special today? Something sweet and crit-worthy?'},
    {who:'cashier',text:'Timing Tap tip: watch the marker rhythm — it speeds up!'},
    {who:'customer',text:'Any discounts if I stack items? Asking for a friend…'},
    {who:'cashier',text:'Buy 3+ items to trigger a cart discount. Pro shopper move.'}
  ],
  paid:[
    {who:'cashier',text:'Order locked. Just a single signature away!'},
    {who:'customer',text:'That routing viz looked slick — feels instant!'}
  ],
  afterQuest:[
    {who:'cashier',text:'Quest cleared! Enjoy the bonus XP and perks.'},
    {who:'customer',text:'I’ll be back — that combo buff was tasty.'}
  ]
};
const QUESTS=[
  {id:'q1',title:'Buy a Latte ☕ + Croissant 🥐', need:{Latte:1,Croissant:1}, reward:30},
  {id:'q2',title:'Cold Brew 🥤 + Blueberry Muffin 🧁', need:{'Cold Brew':1,'Blueberry Muffin':1}, reward:30},
  {id:'q3',title:'Beans (250g) 🫘 + Espresso ☕', need:{'Beans (250g)':1,Espresso:1}, reward:35}
];
let lineIdx=0, curSet='idle', typing=false;
function talk(){ if(typing) return; const set=LINES[curSet]||LINES.idle; const line=set[lineIdx%set.length]; lineIdx++; say(line.who,line.text); if(curSet!=='idle' && lineIdx>=set.length){curSet='idle';lineIdx=0}}
function say(who,txt){
  const bubble=$('bubble'); const cash=$('cashEmote'); const cust=$('custEmote');
  if(!bubble) return;
  bubble.innerHTML=''; typing=true; let i=0; const timer=setInterval(()=>{bubble.innerHTML=txt.slice(0,++i); if(i>=txt.length){typing=false;clearInterval(timer)}},10);
  if(who==='cashier'){flashEmote(cash,'💡')} else {flashEmote(cust,'✨')}
}
function flashEmote(el,emoji){ if(!el){ pixelSparkles(); return; } el.textContent=emoji; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),600); }
const talkBtn = $('btnTalkScene'); if(talkBtn){ talkBtn.onclick=()=>{SFX.click(); talk()} }
$('btnQuest').onclick=()=>{SFX.click(); startQuest(); talk();};
addEventListener('keydown',e=>{if(e.key && e.key.toLowerCase()==='e'){talk()}});

function startQuest(){
  const q = pick(QUESTS);
  GAME.quest={id:q.id,need:q.need,done:false,reward:q.reward,title:q.title};
  log('quest','Started: '+q.title,'info');
  toast('Quest Started',q.title,'good');
  say('cashier','Quest: '+q.title+' — complete it for bonus XP!');
}
function checkQuestProgress(){
  if(!GAME.quest||GAME.quest.done) return;
  const need=GAME.quest.need;
  const hasAll = Object.entries(need).every(([name,qty])=>{
    const p=STORE.find(x=>x.name===name); return p && (CART.get(p.id)||0)>=qty;
  });
  if(hasAll){
    GAME.quest.done=true; award(GAME.quest.reward,'quest');
    flashEmote($('cashEmote'),'🏆'); say('cashier','Quest complete! Head to checkout.');
    log('quest','Complete!','good'); toast('Quest Complete','Proceed to checkout','good');
    curSet='afterQuest'; lineIdx=0;
  }
}

/* =============================== PIXEL SPRITES =============================== */
let pixelFrame=0, pixelAnim=null, ROLE='hero', custAction='idle', cashAction='idle';
const PALETTES={
  adventurer:{shadow:'#0b0f1a', pants:'#6b2c2c', boot:'#2b1a12', shirt:'#b11e2e', trim:'#f1c74a', skin:'#f2c79b', hair:'#3b2a28', eye:'#111', cup:'#6b3e2e'},
  mage:{shadow:'#0b0f1a', pants:'#3a1a1a', boot:'#1e1412', shirt:'#8b1230', trim:'#ffd166', skin:'#f2c79b', hair:'#2a1a28', eye:'#111', cup:'#6b3e2e'},
  hero:{shadow:'#0b0f1a', pants:'#7b2a2a', boot:'#2a1a1a', shirt:'#c2272f', trim:'#ffcc55', skin:'#f2c79b', hair:'#222', eye:'#111', cup:'#6b3e2e'}
};
function ensurePixelCanvas(){ ['cust','cashier'].forEach(id=>{const host=$(id); if(!host) return; let cv=host.querySelector('canvas'); if(!cv){host.classList.add('pixel'); host.innerHTML='<canvas width="32" height="32"></canvas>'}}); }
function clearPixel(){ ['cust','cashier'].forEach(id=>{const host=$(id); if(!host) return; host.classList.remove('pixel'); host.innerHTML='<div class="avFace">'+(id==='cashier'?'🧙‍♂️':'🧑‍🚀')+'</div><div class="emote" id="'+(id==='cashier'?'cashEmote':'custEmote')+'">✨</div>'; }); }
function px(ctx,x,y,w,h,c){ctx.fillStyle=c;ctx.fillRect(x,y,w,h)}
function drawDude(ctx, pal, frame, action){
  const f=frame%4; ctx.clearRect(0,0,32,32);
  px(ctx,7,26,18,2,pal.shadow);
  const legOff = [0,1,0,-1][f];
  px(ctx,10,20+Math.max(0,legOff),4,6, pal.pants);
  px(ctx,18,20+Math.max(0,-legOff),4,6, pal.pants);
  px(ctx,10,25+Math.max(0,legOff),4,1, pal.boot);
  px(ctx,18,25+Math.max(0,-legOff),4,1, pal.boot);
  px(ctx,8,12,16,9,pal.shirt); px(ctx,8,12,16,2,pal.trim);
  if(action==='swing'){ px(ctx,22,9,3,8,pal.skin); px(ctx,24,8,3,3,pal.cup); px(ctx,25,7,1,1,'#ffd166'); px(ctx,7,14,3,7,pal.skin); }
  else { const ao = [0,1,0,-1][(f+2)%4]; px(ctx,7,13+Math.max(0,ao),3,7,pal.skin); px(ctx,22,13+Math.max(0,-ao),3,7,pal.skin); }
  px(ctx,10,5,12,7,pal.skin); px(ctx,10,4,12,2,pal.hair); px(ctx,13,7,2,2,pal.eye); px(ctx,19,7,2,2,pal.eye);
}
function renderPixelAvatars(){ ensurePixelCanvas(); const custCv=$('cust').querySelector('canvas'); const cashCv=$('cashier').querySelector('canvas');
  if(!custCv||!cashCv) return; const pal=PALETTES[ROLE]||PALETTES.hero; const palCash=ROLE==='mage'?PALETTES.mage:pal; const c1=custCv.getContext('2d'), c2=cashCv.getContext('2d');
  drawDude(c1,pal,pixelFrame,custAction); drawDude(c2,palCash,(pixelFrame+2)%4,cashAction); }
function startPixelAnim(){ if(pixelAnim) return; pixelAnim=setInterval(()=>{pixelFrame=(pixelFrame+1)%4; renderPixelAvatars();},220) }
function stopPixelAnim(){ clearInterval(pixelAnim); pixelAnim=null; }
addEventListener('change',e=>{ if(e.target && e.target.id==='roleSel'){ ROLE=e.target.value; renderPixelAvatars(); }});

/* Pixel FX */
function pixelSparkles(){ const cv=document.createElement('canvas'); cv.width=innerWidth; cv.height=innerHeight; cv.style.cssText='position:fixed;inset:0;pointer-events:none;z-index:130;image-rendering:pixelated;'; document.body.appendChild(cv); const ctx=cv.getContext('2d');
  const P=[]; for(let i=0;i<80;i++){P.push({x:innerWidth/2,y:innerHeight/2,dx:(Math.random()-0.5)*4,dy:(Math.random()-1)*4,a:1,sz:3+Math.floor(Math.random()*3),c: ['#ff355e','#ffd166','#fff'][Math.floor(Math.random()*3)]});}
  let t=0; (function tick(){ ctx.clearRect(0,0,cv.width,cv.height); P.forEach(p=>{p.x+=p.dx; p.y+=p.dy; p.dy+=0.08; p.a-=0.02; ctx.globalAlpha=Math.max(0,p.a); ctx.fillStyle=p.c; ctx.fillRect(p.x|0,p.y|0,p.sz,p.sz)}); ctx.globalAlpha=1; if(t++<50){requestAnimationFrame(tick)} else cv.remove(); })(); }
function pixelBurst(){ const cv=document.createElement('canvas'); cv.width=innerWidth; cv.height=innerHeight; cv.style.cssText='position:fixed;inset:0;pointer-events:none;z-index:129;image-rendering:pixelated;'; document.body.appendChild(cv); const ctx=cv.getContext('2d');
  const parts=[]; for(let i=0;i<40;i++){ const ang=Math.random()*Math.PI*2, sp=2+Math.random()*3; parts.push({x:innerWidth/2,y:innerHeight/2,dx:Math.cos(ang)*sp,dy:Math.sin(ang)*sp,a:1}); }
  let t=0; (function tick(){ ctx.clearRect(0,0,cv.width,cv.height); ctx.fillStyle='#ffcc55'; parts.forEach(p=>{p.x+=p.dx; p.y+=p.dy; p.a-=0.03; ctx.globalAlpha=Math.max(0,p.a); ctx.fillRect(p.x|0,p.y|0,4,4)}); ctx.globalAlpha=1; if(t++<36){requestAnimationFrame(tick); } else cv.remove(); })(); }

/* Wall menu dots */
function drawPixelMenu(){
  const cv=$('menuBoard'); if(!cv) return; const ctx=cv.getContext('2d'); const w=cv.width, h=cv.height;
  ctx.fillStyle='#120d16'; ctx.fillRect(0,0,w,h);
  ctx.fillStyle='#ff2f55'; ctx.fillRect(3,3,w-6,10);
  ctx.fillStyle='#ffd166'; ctx.fillRect(4,4,w-8,8);
  ctx.fillStyle='#2a1420'; for(let x=6;x<w-6;x+=3){ ctx.fillRect(x,6,1,1) }
  const items=STORE.slice(0,6); let y=16;
  items.forEach((it,i)=>{
    ctx.fillStyle= i%2? '#1b131d' : '#161018'; ctx.fillRect(4,y,w-8,8);
    ctx.fillStyle='#c7b7d2'; const nm=(it.name.toUpperCase()).slice(0,10);
    for(let j=0;j<nm.length;j++){ if(nm[j]!==' '){ ctx.fillRect(6+j*3,y+3,1,1) } }
    const p=(it.price.toFixed(2)).replace('.',':'); let px=w-8 - p.length*3;
    ctx.fillStyle='#ffd166'; for(let j=0;j<p.length;j++){ if(p[j]!==':'){ ctx.fillRect(px+j*3,y+3,1,1) } else { ctx.fillRect(px+j*3,y+5,1,1) } }
    y+=10;
  });
}

/* =============================== MENU =============================== */
let ACTIVE_CAT='all';
function renderMenu(q=''){
  q=q.trim().toLowerCase();
  const list=STORE.filter(p=>{
    const catOK = (ACTIVE_CAT==='all') || p.cat===ACTIVE_CAT;
    return catOK && (!q || p.name.toLowerCase().includes(q) || p.desc.toLowerCase().includes(q))
  });
  const grid=$('grid'); if(!grid) return; grid.innerHTML='';
  list.forEach(p=>{
    const c=document.createElement('div');
    c.className='card';
    const tags=(p.tags||[]).slice(0,3).map(t=>`<span class="badge">${t}</span>`).join('');
    c.innerHTML=`<div class="thumb">${p.icon}</div>
      <div><div class="title">${p.name}</div><div class="desc">${p.desc}</div><div class="tags">${tags}</div></div>
      <div class="actions">
        <div class="price">${money(p.price)}</div>
        <button class="btn add primary" data-id="${p.id}" aria-label="Add ${p.name}">＋ Add</button>
      </div>`;
    c.querySelector('button').onclick=()=>add(p.id,1);
    grid.appendChild(c)
  });
  drawPixelMenu();
}
$('search').oninput=e=>renderMenu(e.target.value);
document.getElementById('menuTabs').addEventListener('click',e=>{
  const b=e.target.closest('.tabBtn'); if(!b) return; document.querySelectorAll('.tabBtn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); ACTIVE_CAT=b.dataset.cat||'all'; renderMenu($('search').value||'');
});

/* =============================== CART (smarter) =============================== */
function saveCart(){ try{ localStorage.setItem('ap_cart', JSON.stringify([...CART.entries()])) }catch{} }
function loadCart(){ try{ const raw=localStorage.getItem('ap_cart'); if(raw){ const arr=new Map(JSON.parse(raw)); arr.forEach((q,id)=>CART.set(id,q)); } }catch{} }
function calcDiscount(sub,qty){
  let d=0;
  if(qty>=3) d+= +(sub*0.05).toFixed(2);            // 5% cart discount for 3+
  if(GAME.combo>=50) d+= +Math.min(2,sub*0.02).toFixed(2); // small combo perk
  if(GAME.quest && GAME.quest.done) d+=0.50;        // quest perk
  return +d.toFixed(2);
}
function totals(){
  let sub=0,qty=0; CART.forEach((q,id)=>{const p=STORE.find(x=>x.id===id); sub+=p.price*q; qty+=q});
  const discount=calcDiscount(sub,qty);
  const tax=+((sub-discount)*TAX).toFixed(2);
  const fee=+((sub-discount)*0.004).toFixed(2);
  const total=+(sub-discount+tax+fee).toFixed(2);
  return {sub,discount,tax,fee,total,qty}
}
function add(id,n){
  startTimer();
  const cur=CART.get(id)||0;const q=Math.max(0,cur+n);if(q===0)CART.delete(id);else CART.set(id,q);
  paintCart(); saveCart();
  const p=STORE.find(x=>x.id===id);log('cart',`${n>0?'+':'−'} ${p.name}`,n>0?'good':'warn'); 
  if(n>0){ SFX.coin(); bump(); missionTick('items',1); toast('Added', p.name+' ×1','good');
    if(SKIN==='pixel-retro'){custAction='walk'; renderPixelAvatars(); setTimeout(()=>{custAction='idle';},900);} }
  checkQuestProgress();
}
function payBtnState(){ const has=CART.size>0; const b=$('btnPay'); b.disabled=!has; }
function paintSmartBox(){
  const sb=$('smartBox'), list=$('smartList');
  const recs=[];
  if(GAME.quest && !GAME.quest.done){
    Object.keys(GAME.quest.need).forEach(name=>{
      const p=STORE.find(x=>x.name===name);
      const have=(CART.get(p.id)||0);
      const need=GAME.quest.need[name];
      if(have<need) recs.push({p,why:'Quest item'});
    });
  }
  STORE.filter(p=>!CART.has(p.id)).sort((a,b)=>a.price-b.price).slice(0,2).forEach(p=>recs.push({p,why:'Popular'}));
  if(recs.length===0){ sb.classList.add('hidden'); return;}
  sb.classList.remove('hidden');
  list.innerHTML = recs.map(({p,why}) => `<div class="qitem"><div>${p.icon} ${p.name} <span class="tag">${why}</span></div><div><button class="btn pill" data-add="${p.id}">+ Add</button></div></div>`).join('');
  list.querySelectorAll('[data-add]').forEach(b=>b.onclick=()=>add(b.dataset.add,1));
}
function paintCart(){
  const box=$('cart'); if(!box) return; box.innerHTML='';
  if(CART.size===0) box.innerHTML='<div class="desc">Your cart is empty.</div>';
  CART.forEach((q,id)=>{const p=STORE.find(x=>x.id===id);const row=document.createElement('div');row.className='cartRow';
    row.innerHTML=`<div class="name">${p.name}</div><div>${money(p.price)}</div>
      <div class="qtyCtl"><button class="btn ghost">−</button><div>${q}</div><button class="btn ghost">+</button></div>
      <div>${money(p.price*q)}</div>`;
    const [dec,inc]=row.querySelectorAll('button');dec.onclick=()=>add(id,-1);inc.onclick=()=>add(id,1);box.appendChild(row)});
  const t=totals();
  $('subtotal').textContent=money(t.sub);
  $('discount').textContent='-'+money(t.discount).slice(1);
  $('tax').textContent=money(t.tax);$('fees').textContent=money(t.fee);$('total').textContent=money(t.total);
  $('hudItems').textContent=t.qty;$('hudTotal').textContent=money(t.total);
  payBtnState(); paintSmartBox();
  box.scrollTop=box.scrollHeight;
}
$('btnClear').onclick=()=>{CART.clear();paintCart();saveCart();log('cart','cleared','warn');toast('Cart','Cleared','warn')}

/* =============================== PAY =============================== */
function route(amount){const from=pick(CHAINS), hops=Math.random()<0.5?[pick(BRIDGES)]:[pick(BRIDGES),pick(CHAINS)], to=pick(CHAINS.filter(c=>c!==from));
  const fee=+(amount*(0.0012+Math.random()*0.0028)).toFixed(2), slip=+(Math.random()*0.45).toFixed(2), eta=Math.max(3,2+hops.length*1.3)|0;return {path:[from,...hops,to],fee,slip,eta}}
function buildIntent(){const t=totals();return {merchant:'ANOMAPAY CAFE',amount:t.total,assets:'USDC → USDC',privacy:'ZK',policy:{maxSlip:0.5,avoid:[]},cartSnap:[...CART.entries()],discount:t.discount}}
function drawCompare(iv,rt){const cardFee=+(iv.amount*0.027).toFixed(2),cardTime=8,anomaFee=+rt.fee.toFixed(2),anomaTime=rt.eta;
  const maxF=Math.max(cardFee,anomaFee)||1, maxT=Math.max(cardTime,anomaTime);
  $('compare').innerHTML=[ mk('Fees',anomaFee,cardFee,maxF,'$'), mk('ETA (s)',anomaTime,cardTime,maxT,'') ].join('');
  function mk(label,a,c,max,s){const aw=Math.round(a/max*100),cw=Math.round(c/max*100); return `
  <div class="bar"><div>${label}</div><div class="track"><div class="fill" style="width:${aw}%"></div></div><div>${s}${a}</div></div>
  <div class="bar" style="opacity:.75"><div>Card</div><div class="track"><div class="fill" style="width:${cw}%;background:linear-gradient(90deg,#ff7a7a,#ffb36a)"></div></div><div>${s}${c}</div></div>`;}}
function openPay(){ if(CART.size===0){log('pay','Cart is empty','warn');SFX.warn();toast('Pay','Cart is empty','bad');return}
  const iv=buildIntent(), rt=route(iv.amount);
  $('iAmount').textContent=money(iv.amount);$('iAssets').textContent=iv.assets;$('iPrivacy').textContent=iv.privacy;
  $('iPolicy').textContent=`max slip ${iv.policy.maxSlip}% · avoid —`;$('iRoute').textContent=rt.path.join(' → ');
  $('iETA').textContent=rt.eta+' s';$('iFees').textContent=money(rt.fee);$('iSlip').textContent=rt.slip+'%';
  $('iHops').innerHTML=rt.path.map((p,i)=> i<rt.path.length-1?`<div>Hop ${i+1}: ${rt.path[i]} → ${rt.path[i+1]}</div>`:'').join('');
  drawRoute(rt.path); drawCompare(iv,rt); drawQR(makeQR(iv));
  $('payOv')._st={iv,rt};$('payOv').classList.add('show');SFX.click();log('intent',`amount=${money(iv.amount)} route=${rt.path.join('→')}`,'info'); skillStart();
  curSet='paid'; lineIdx=0; talk();
}
$('btnPay').onclick=openPay;
$('btnClosePay').onclick=()=>$('payOv').classList.remove('show');
$('btnSimScan').onclick=()=>{SFX.click();log('scan','payer scanned (sim)','good')};
$('btnApprove').onclick=()=>{const s=$('payOv')._st;if(!s)return;
  $('payOv').classList.remove('show');SFX.success();
  missionTick('pay',1); missionTick('zk',1); MISSIONS.state.spent=+(MISSIONS.state.spent||0)+s.iv.amount;
  bossCheck(s);
  if(SKIN==='pixel-retro'){ cashAction='swing'; renderPixelAvatars(); setTimeout(()=>{cashAction='idle';},1200); pixelBurst(); pixelSparkles(); }
  buildReceiptFromSnap(s.iv,s.rt); showReceipt();
  CART.clear();paintCart();saveCart();stopTimer();award(25,'checkout');GAME.streak++;updateHUD();confetti();toast('Payment','Approved & Settled','good')
};
function drawRoute(path){const box=$('routeVis');box.innerHTML='';const w=box.clientWidth||480,h=box.clientHeight||96,p=28,n=path.length,dx=(w-2*p)/Math.max(1,n-1);
  const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');svg.setAttribute('viewBox',`0 0 ${w} ${h}`);
  for(let i=0;i<n-1;i++){const e=document.createElementNS(svg.namespaceURI,'line');e.setAttribute('x1',p+i*dx);e.setAttribute('y1',h/2);e.setAttribute('x2',p+(i+1)*dx);e.setAttribute('y2',h/2);e.setAttribute('stroke','#ff6a8a');e.setAttribute('stroke-dasharray','6 6');e.setAttribute('stroke-width','3');svg.appendChild(e)}
  path.forEach((name,i)=>{const g=document.createElementNS(svg.namespaceURI,'g'),cx=p+i*dx,cy=h/2;const c=document.createElementNS(svg.namespaceURI,'circle');c.setAttribute('cx',cx);c.setAttribute('cy',cy);c.setAttribute('r',11);
    c.setAttribute('fill','#20396a');c.setAttribute('stroke','#ff6a8a');c.setAttribute('stroke-width','2');const t=document.createElementNS(svg.namespaceURI,'text');t.setAttribute('x',cx);t.setAttribute('y',cy-16);t.setAttribute('fill','#d7e6ff');t.setAttribute('font-size','11');t.setAttribute('text-anchor','middle');t.textContent=name;g.appendChild(c);g.appendChild(t);svg.appendChild(g)});box.appendChild(svg)}
function makeQR(iv){const str=`anoma://pay?to=${encodeURIComponent(iv.merchant)}&amount=${iv.amount.toFixed(2)}&ccy=USD&assets=${encodeURIComponent(iv.assets)}&privacy=${iv.privacy}&nonce=${Math.random().toString(16).slice(2,8)}`;$('qrStr').textContent=str;return str}
function drawQR(str){const c=$('qrCanvas'),ctx=c.getContext('2d');ctx.clearRect(0,0,c.width,c.height);ctx.fillStyle='#0b1120';ctx.fillRect(0,0,c.width,c.height);
  const seed=str.split('').reduce((a,b)=>a+b.charCodeAt(0),0);let r=seed;function rnd(){r=(r*9301+49297)%233280;return r/233280;}
  ctx.fillStyle='#f5f8ff';for(let y=8;y<c.height-8;y+=6){for(let x=8;x<c.width-8;x+=6){if(rnd()>.47)ctx.fillRect(x,y,2,2)}}ctx.strokeStyle='#ff7a9a';ctx.lineWidth=3;[[22,22],[c.width-46,22],[22,c.height-46]].forEach(([x,y])=>ctx.strokeRect(x,y,24,24));}

/* =============================== TIMING TAP =============================== */
let SKILL={dir:1,x:0.05,raf:0,round:1,score:0,speed:0.012};
function skillReset(){SKILL.round=1;SKILL.score=0;$('roundBadge').textContent='Round 1/3';$('scoreBadge').textContent='Score 0'}
function skillStart(){skillReset(); SKILL.x=Math.random()*0.2+0.05; moveZone(true); if(SKILL.raf) cancelAnimationFrame(SKILL.raf); animate()}
function setBadges(){ $('roundBadge').textContent=`Round ${SKILL.round}/3`; $('scoreBadge').textContent=`Score ${SKILL.score}` }
function moveZone(init=false){
  const z=$('skillZone'); if(!z) return;
  const w = 12+Math.random()*18;
  const shrink = (SKILL.round-1)*2.5 + (DIFF-1)*6;
  const width=Math.max(8,w-shrink);
  const left= 38+Math.random()*24;
  z.style.left=left+'%'; z.style.width=width+'%';
  if(!init){ $('skillBand').classList.remove('shake'); }
}
function animate(){const m=$('skillMark'); if(!m){return}
  const speed = (SKILL.speed*DIFF)*(1 + (SKILL.round-1)*0.25);
  SKILL.x+=SKILL.dir*speed; if(SKILL.x<=0||SKILL.x>=0.985) SKILL.dir*=-1; m.style.left=(SKILL.x*100)+'%';
  SKILL.raf=requestAnimationFrame(animate)
}
function bandShake(){ const b=$('skillBand'); if(!b) return; b.classList.add('shake'); setTimeout(()=>b.classList.remove('shake'),450)}
$('skillTap').onclick=()=>{
  const s=$('payOv')._st;if(!s)return; const z=$('skillZone'); if(!z) return; const zl=parseFloat(z.style.left)||40, zw=parseFloat(z.style.width)||20, px=SKILL.x*100;
  const center=zl+zw/2, dist=Math.abs(px-center), ok=px>=zl && px<=zl+zw;
  const q=Math.max(zw,8);
  const critBound=q*0.12, greatBound=q*0.28, goodBound=q*0.5;
  const note=$('skillNote'), critLbl=$('crit');

  if(ok){
    let tier='Good';
    if(dist<=critBound){ tier='Perfect'; }
    else if(dist<=greatBound){ tier='Great'; }
    else if(dist<=goodBound){ tier='Good'; }

    if(tier==='Perfect'){ s.rt.fee=+(s.rt.fee*0.60).toFixed(2); s.rt.slip=+(s.rt.slip*0.70).toFixed(2); SFX.perfect(); SKILL.score+=30;
      if(critLbl){critLbl.style.opacity=1; critLbl.style.transform='translate(-50%,-80%)'; setTimeout(()=>{critLbl.style.opacity=0; critLbl.style.transform='translate(-50%,-50%)'},380);}
      award(10,'Perfect'); MISSIONS.state.perfect=(MISSIONS.state.perfect||0)+1;
    }else if(tier==='Great'){ s.rt.fee=+(s.rt.fee*0.72).toFixed(2); s.rt.slip=+(s.rt.slip*0.80).toFixed(2); SFX.great(); SKILL.score+=18; award(6,'Great');
    }else{ s.rt.fee=+(s.rt.fee*0.85).toFixed(2); SFX.good(); SKILL.score+=10; award(4,'Good'); }

    $('iFees').textContent=money(s.rt.fee); $('iSlip').textContent=s.rt.slip+'%'; drawCompare(s.iv,s.rt);

    if(SKILL.round<3){ SKILL.round++; moveZone(); setBadges(); note.textContent=`Nice! You hit ${tier}. Next round is faster.`; }
    else { note.textContent=`Final score ${SKILL.score}. You’re good to go!`; SFX.success(); }
  } else {
    bandShake(); SFX.warn(); note.textContent='Miss! Small penalty — try again (optional).';
    s.rt.fee=+(s.rt.fee*1.03).toFixed(2); $('iFees').textContent=money(s.rt.fee); drawCompare(s.iv,s.rt);
  }
};

/* =============================== RECEIPT =============================== */
function buildReceiptFromSnap(iv,rt){
  $('rcpTime').textContent=new Date().toLocaleString();
  const tbody=$('rcpTbl').querySelector('tbody');tbody.innerHTML='';
  iv.cartSnap.forEach(([id,q])=>{const p=STORE.find(x=>x.id===id)||{name:id,price:0};const tr=document.createElement('tr');
    tr.innerHTML=`<td>${p.name}</td><td>${q}</td><td>${money(p.price*q)}</td>`;tbody.appendChild(tr)});
  $('rcpFoot').innerHTML=`
    <div>Discounts <b>-${money(iv.discount).slice(1)}</b></div>
    <div>Fees <b>${money(rt.fee)}</b></div>
    <div>Slippage <b>${rt.slip}%</b></div>
    <div><b>Total</b> ${money(iv.amount)}</div>
    <div>Route ${rt.path.join(' → ')}</div>
    <div>Assets ${iv.assets}</div>
    <div id="rcpTx">tx ${'0x'+Math.random().toString(16).slice(2,14)}</div>`;
}
function showReceipt(){ $('rcpOv').classList.add('show'); }
$('rcpClose').onclick=()=>$('rcpOv').classList.remove('show');
$('rcpCopy').onclick=()=>{const txt=$('rcpCard').innerText;navigator.clipboard.writeText(txt);log('share','receipt copied','good');toast('Receipt','Copied to clipboard','good')}

/* =============================== MISSIONS =============================== */
const MISSIONS={
  daily:[
    {id:'d_items', title:'Add 5 items', key:'items', need:5, reward:10},
    {id:'d_pay', title:'Complete 1 payment', key:'pay', need:1, reward:15},
    {id:'d_zk', title:'Use ZK once', key:'zk', need:1, reward:20},
    {id:'d_perfect', title:'Hit one Perfect', key:'perfect', need:1, reward:12},
  ],
  weekly:[
    {id:'w_total', title:'Spend $50 total', key:'spent', need:50, reward:40},
    {id:'w_combo', title:'Reach 80 combo', key:'combo', need:80, reward:25},
  ],
  state:{items:0,pay:0,zk:0,spent:0,combo:0,perfect:0}
};
function missionTick(key, inc){MISSIONS.state[key]=(MISSIONS.state[key]||0)+inc; if(key==='combo') MISSIONS.state.combo=Math.max(MISSIONS.state.combo, Math.round(GAME.combo));}
function updateMissionUI(){
  const mk=(list,box)=>{box.innerHTML=''; list.forEach(m=>{const cur= (m.key==='spent'?MISSIONS.state.spent:MISSIONS.state[m.key]||0);
    const done=cur>=m.need || localStorage.getItem('m_'+m.id)==='1';
    const row=document.createElement('div'); row.className='qitem';
    row.innerHTML=`<div><div>${m.title}</div><div class="tag">${cur}/${m.need}</div></div>
      <div>${done?'<span class="tag">Claimed</span>':'<button class="btn pill">Claim +'+m.reward+' XP</button>'}</div>`;
    if(!done){const btn=row.querySelector('button'); btn.onclick=()=>{ const cur2=(m.key==='spent'?MISSIONS.state.spent:MISSIONS.state[m.key]||0); if(cur2>=m.need){localStorage.setItem('m_'+m.id,'1'); award(m.reward,'mission'); updateMissionUI(); SFX.success();} else {SFX.warn();}}
    }
    box.appendChild(row);
  })};
  mk(MISSIONS.daily,$('dailyBox')); mk(MISSIONS.weekly,$('weeklyBox'));
}
$('btnMissions').onclick=()=>{updateMissionUI(); $('missionOv').classList.add('show');SFX.click()};
$('closeMissions').onclick=()=>$('missionOv').classList.remove('show');

/* =============================== BOSS =============================== */
let BOSS=null, bossTimer=null;
$('btnBoss').onclick=()=>{ const amt=10+Math.floor(Math.random()*20), avoid=pick(['Base','BSC','Osmosis','Polygon']); BOSS={needAmt:amt,avoid:avoid,secs:40,run:false};
  $('bossRule').textContent=`Pay ≥ $${amt} with ZK and avoid ${avoid} within 40s.`; $('bossFill').style.width='0%'; $('bossOv').classList.add('show'); SFX.click()};
$('bossStart').onclick=()=>{ if(!BOSS) return; BOSS.run=true; $('bossOv').classList.remove('show'); log('boss','Challenge started','info');
  let s=0; clearInterval(bossTimer); bossTimer=setInterval(()=>{s++; $('bossFill').style.width=(s/40*100)+'%'; if(s>=40){clearInterval(bossTimer);BOSS=null;log('boss','Failed','bad');SFX.warn();}},1000)};
$('bossClose').onclick=()=>$('bossOv').classList.remove('show');
function bossCheck(state){ if(!BOSS||!BOSS.run) return; clearInterval(bossTimer);
  const okAmt=state.iv.amount>=BOSS.needAmt, avoidOK=!state.rt.path.some(x=>x.toLowerCase()===BOSS.avoid.toLowerCase());
  if(okAmt&&avoidOK&&state.iv.privacy==='ZK'){ log('boss','Defeated!','good'); award(60,'boss'); confetti(); toast('Boss','Defeated!','good'); } else { log('boss','Failed (rule mismatch)','bad'); toast('Boss','Failed (rule mismatch)','bad'); } BOSS=null;}

/* =============================== SKINS & SETTINGS =============================== */
$('btnSkins').onclick=()=>$('skinOv').classList.add('show');
$('skinClose').onclick=()=>$('skinOv').classList.remove('show');
document.querySelectorAll('.skin').forEach(el=>el.onclick=()=>{document.querySelectorAll('.skin').forEach(x=>x.classList.remove('active'));el.classList.add('active');SKIN=el.dataset.skin;applySkin()});
$('btnSetup').onclick=()=>{ $('skinSel').value=SKIN; $('fsSel').value=String(FONT_SCALE); $('soundChk').checked=SOUND; $('ccySel').value=CCY; $('diffSel').value=String(DIFF); $('settingsOv').classList.add('show');};
$('btnCloseSettings').onclick=()=>$('settingsOv').classList.remove('show');
$('btnSaveSettings').onclick=()=>{
  SKIN=$('skinSel').value; FONT_SCALE=parseFloat($('fsSel').value||'1'); SOUND=$('soundChk').checked; CCY=$('ccySel').value; DIFF=parseFloat($('diffSel').value||'1');
  try{ localStorage.setItem('ap_skin',SKIN); localStorage.setItem('ap_fs',String(FONT_SCALE)); localStorage.setItem('ap_sound',SOUND?'1':'0'); localStorage.setItem('ap_ccy',CCY); localStorage.setItem('ap_diff',String(DIFF)); }catch{}
  applySkin(); paintCart(); renderMenu(); $('settingsOv').classList.remove('show'); toast('Settings','Saved','good');
};
function applySkin(){
  document.documentElement.style.setProperty('font-size', (FONT_SCALE*100)+'%');
  // Theme core is already red–black; skins mainly swap panel glass intensity & enable pixel avatars
  if(SKIN==='white-air'){
    document.querySelector('.game').style.background='rgba(255,255,255,.06)';
    clearPixel(); stopPixelAnim();
  } else if(SKIN==='pro-dark'){
    document.querySelector('.game').style.background='rgba(14,16,24,.62)';
    clearPixel(); stopPixelAnim();
  } else if(SKIN==='pixel-retro'){
    document.querySelector('.game').style.background='rgba(20,9,15,.72)';
    ensurePixelCanvas(); renderPixelAvatars(); startPixelAnim();
  } else { // apple-redglass
    document.querySelector('.game').style.background='rgba(20,9,15,.62)';
    clearPixel(); stopPixelAnim();
  }
}

/* =============================== MISC =============================== */
$('btnFull').onclick=async()=>{const g=$('game');if(!document.fullscreenElement){try{await g.requestFullscreen()}catch{}}else{try{await document.exitFullscreen()}catch{}}}
$('btnCopy').onclick=()=>navigator.clipboard.writeText(Array.from(document.querySelectorAll('.logrow')).map(n=>n.innerText).join('\n'));
$('btnClearLog').onclick=()=>$('log').innerHTML='';
$('logSearch').oninput=applyLogFilter;
document.querySelectorAll('.filterBtn').forEach(b=>b.addEventListener('click',()=>{document.querySelectorAll('.filterBtn').forEach(x=>x.classList.remove('active'));b.classList.add('active');applyLogFilter()}));
function applyLogFilter(){
  const q=($('logSearch').value||'').toLowerCase();
  const mode=document.querySelector('.filterBtn.active')?.dataset.f||'all';
  document.querySelectorAll('#log .logrow').forEach(r=>{
    const txt=r.innerText.toLowerCase();
    const kind=r.dataset.kind||'info';
    const show=(mode==='all'||mode===kind) && (!q || txt.includes(q));
    r.style.display=show?'grid':'none';
  });
}
addEventListener('change',e=>{ if(e.target && e.target.id==='roleSel'){ ROLE=e.target.value; renderPixelAvatars(); }});

/* =============================== BOOT =============================== */
function boot(){
  try{
    const s=localStorage.getItem('ap_skin'); if(s) SKIN=s;
    const fs=localStorage.getItem('ap_fs'); if(fs) FONT_SCALE=parseFloat(fs)||1;
    const so=localStorage.getItem('ap_sound'); if(so!==null) SOUND=so==='1';
    const cc=localStorage.getItem('ap_ccy'); if(cc) CCY=cc;
    const df=localStorage.getItem('ap_diff'); if(df) DIFF=parseFloat(df)||1;
  }catch{}
  loadCart();
  renderMenu();paintCart();updateHUD();applySkin();drawPixelMenu();SFX.click();
}
boot();

/* =============================== CONFETTI =============================== */
function confetti(){const c=document.createElement('canvas');c.width=innerWidth;c.height=innerHeight;c.style.cssText='position:fixed;inset:0;z-index:120;pointer-events:none';document.body.appendChild(c);
  const ctx=c.getContext('2d');const parts=Array.from({length:180},()=>({x:Math.random()*c.width,y:-10,r:2+Math.random()*3,dx:(Math.random()-.5)*3,dy:2+Math.random()*3,clr:['#ff6a8a','#ffd166','#6cf','#9bff9b'][Math.floor(Math.random()*4)]}));
  let t=0; (function tick(){ctx.clearRect(0,0,c.width,c.height);parts.forEach(p=>{p.x+=p.dx;p.y+=p.dy;p.dy+=0.02;ctx.fillStyle=p.clr;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill()}); if(t++<140) requestAnimationFrame(tick); else c.remove()})();}

/* mission combo tracker */
setInterval(()=>{MISSIONS.state.combo=Math.max(MISSIONS.state.combo, Math.round(GAME.combo))},1000);

/* draw pixel wall menu when ready */
document.addEventListener('DOMContentLoaded', drawPixelMenu);
</script>
</body>
</html>
